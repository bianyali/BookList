<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>CPS Lecture</title>
<!-- 2015-07-19 Sun 16:55 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Indiana course" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">CPS Lecture</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Introduction</a></li>
<li><a href="#sec-2">2. Implement</a>
<ul>
<li><a href="#sec-2-1">2.1. First rule</a></li>
<li><a href="#sec-2-2">2.2. Second rule</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Property</a>
<ul>
<li><a href="#sec-3-1">3.1. Tail calls</a></li>
<li><a href="#sec-3-2">3.2. Arguments</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Demo</a></li>
</ul>
</div>
</div>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
No published books do this subject justice (including Dan's!)
</p>

<dl class="org-dl">
<dt> Which part of (f (g (h i) j) k) can be done first? </dt><dd>(h i), since it must be evaluated before (g (h i) j) can be applied.<br  />
</dd>

<dt> What about (f (g (h i) (j k)))? </dt><dd>Scheme doesn't specify the order in which arguments are evaluated so it could be either (h i) or (j k).<br  />
</dd>

<dt> So, let's take control (h i (lambda (hi) &#x2026;)). </dt><dd>We assume that hi is the result of applying (h i). Then, we drop in everything else that has to be done to replace the &#x2026;:
</dd>
</dl>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span>f <span style="color: #333333;">(</span>g <span style="color: #333333;">(</span>h i<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>j l<span style="color: #333333;">)))</span>
</pre>
</div>

<p>
becomes
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span>h i <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>hi<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>f <span style="color: #333333;">(</span>g hi <span style="color: #333333;">(</span>j l<span style="color: #333333;">)))))</span>
</pre>
</div>

<p>
(lambda (hi) (f (g hi (j l)))) is a continuation. hi only appears once in the body of the continuation, because hi is intended to replace (h i) and only (h i).
</p>
</div>
</div>



<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Implement</h2>
<div class="outline-text-2" id="text-2">
<p>
Let's write rember in CPS. First, the direct style:
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #8D8D84;">; </span><span style="color: #8D8D84; font-style: italic;">direct style</span>
<span style="color: #8D8D84;">; </span><span style="color: #8D8D84; font-style: italic;">remove the member 8 in the list</span>
<span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">rember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> '<span style="color: #333333;">()]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)]</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>rember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)))])))</span>
</pre>
</div>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> First rule</h3>
<div class="outline-text-3" id="text-2-1">
<p>
<b>First rule: whenever we see a lambda in the code we want to CPS, we have to add an argument, and then process the body:</b>
</p>

<p>
(lambda (x &#x2026;) &#x2026;) =&gt; (lambda (x &#x2026; k) &#x2026;^)
</p>

<p>
Let's start by adding a k to the outer lambda:
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">rember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls k<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> '<span style="color: #333333;">()]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)]</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>rember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)))])))</span>
</pre>
</div>

<p>
Now, to handle the rest of the program, we have to introduce a new rule.
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Second rule</h3>
<div class="outline-text-3" id="text-2-2">
<p>
<b>Second rule: "Don't sweat the small stuff!".</b>
</p>

<ul class="org-ul">
<li>Small stuff is stuff we know will terminate right away.
</li>

<li>Don't sweat the small stuff if we know it will be evaluated.
</li>

<li>Don't sweat the small stuff if it <b>might</b> be evaluated, but instead pass it to k.
</li>
</ul>


<p>
A good example of the first is (null? ls) in the first cond line. We know it will be evaluated, and we know it's small stuff, so we don't have to worry about it. What about the '() that's returned as an answer? The other part of the second rule is that if some small stuff <b>might</b> be evaluated, we just pass it to k. After applying the second rule to the first cond line, we get:
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">rember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls k<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k '<span style="color: #333333;">())]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)]</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>rember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)))])))</span>
</pre>
</div>

<p>
The second cond line also has small stuff in both the test and the return value, so we can treat it just like the first line.
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">rember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls k<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k '<span style="color: #333333;">())]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">))]</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>rember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)))])))</span>
</pre>
</div>

<p>
The else case, however, does <b>not</b> have small stuff as a return value, so we have to build a new continuation:
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">rember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls k<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k '<span style="color: #333333;">())]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">))]</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span>rember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> x<span style="color: #333333;">)))])))</span>
</pre>
</div>

<p>
We're not quite done, though, since we now have small stuff in the body of the continuation. So, we just pass it to k:
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">rember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls k<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k '<span style="color: #333333;">())]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">))]</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span>rember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> x<span style="color: #333333;">))))])))</span>
</pre>
</div>

<p>
This is now completely CPSed, but how do we invoke it? After all, we need a k to pass in. Since (rember8 '() k) should be '(), k can be the identity function (lambda (x) x):
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #006FE0;">&gt;</span> <span style="color: #333333;">(</span>rember8 '<span style="color: #333333;">(</span><span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">6</span> <span style="color: #2e8b57;">7</span> <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">5</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> x<span style="color: #333333;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Property</h2>
<div class="outline-text-2" id="text-3">
<p>
What properties can we observe about this program?
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Tail calls</h3>
<div class="outline-text-3" id="text-3-1">
<p>
First, all non-small stuff calls are tail calls. Here's the program with the tail calls surrounded by asterisks:
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">rember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls k<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>*k* '<span style="color: #333333;">())]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span>*k* <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">))]</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span>*rember8* <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>*k* <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> x<span style="color: #333333;">))))])))</span>
</pre>
</div>

<p>
Why don't null?, =, car, cdr, and cons count? Because they're just small stuff, and when we combine small stuff together in small ways, the combination remains small.
</p>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Arguments</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Second, all arguments are small stuff. Yep, even the lambda in the else line, because lambda is <b>always</b> small stuff.
</p>

<p>
Notice that this is essentially a C program. All we have to do is <b><span class="underline">convert the continuations to data structures</span></b> (remember how we did the same thing with closures).
</p>

<p>
Let's trace (rember8  (lambda (x) x))
</p>

<div class="org-src-container">

<pre class="src src-racket">ls                   | k

'<span style="color: #333333;">(</span><span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">6</span> <span style="color: #2e8b57;">7</span> <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">5</span><span style="color: #333333;">)</span> | <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> x<span style="color: #333333;">)</span> <span style="color: #006FE0;">=</span> id
'<span style="color: #333333;">(</span><span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">6</span> <span style="color: #2e8b57;">7</span> <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">5</span><span style="color: #333333;">)</span>   | <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>id <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #2e8b57;">1</span> x<span style="color: #333333;">)))</span> <span style="color: #006FE0;">=</span> k2
'<span style="color: #333333;">(</span><span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">6</span> <span style="color: #2e8b57;">7</span> <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">5</span><span style="color: #333333;">)</span>     | <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k2 <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #2e8b57;">2</span> x<span style="color: #333333;">)))</span> <span style="color: #006FE0;">=</span> k3
</pre>
</div>

<p>
Once we hit the 8, we apply <i>(k (cdr ls))</i> where k is k3 and ls is '(8 3 4 6 7 8 5)
</p>

<p>
(k3 '(3 4 6 7 8 5)) = (k2 (cons 2 '(3 4 6 7 8 5)))
(k2 '(2 3 4 6 7 8 5)) = (id (cons 1 '(2 3 4 6 7 8 5)))
(id '(1 2 3 4 6 7 8 5)) = '(1 2 3 4 6 7 8 5)
</p>

<p>
And we're done.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Demo</h2>
<div class="outline-text-2" id="text-4">
<p>
Let's try a more complicated program, multirember8. Instead of just removing the first 8, it'll remove all of the 8s.
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">multirember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> '<span style="color: #333333;">()]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span>multirember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">))]</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>multirember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)))])))</span>
</pre>
</div>

<p>
Now, let's start CPSing by going back to our CPSed rember8:
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">multirember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls k<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k '<span style="color: #333333;">())]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span>multirember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">))]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">uh-oh!</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span>multirember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> x<span style="color: #333333;">))))])))</span>
</pre>
</div>

<p>
What do we need to do for the second line? Since multirember8 takes two arguments, we need to now pass it a continuation.
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">multirember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls k<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k '<span style="color: #333333;">())]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span>multirember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k x<span style="color: #333333;">)))]</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span>multirember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> x<span style="color: #333333;">))))])))</span>
</pre>
</div>

<p>
But what's (lambda (x) (k x)) doing? It's taking whatever is passed to it, and passing it to k. This whole expression, therefore, is equivalent to k.
</p>

<p>
Eta reduction: (lambda (x) (M x)) = M if x is not free in M and M is guaranteed to terminate. M is any arbitrary expression that satisfies these rules; it doesn't have to be only a single variable like k.
</p>

<p>
So, whenever you see a tail call, you don't even have to think about eta. Just pass k to it.
</p>

<div class="org-src-container">

<pre class="src src-racket"><span style="color: #333333;">(</span><span style="color: #0000FF;">define</span> <span style="color: #BA36A5;">multirember8</span>
  <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>ls k<span style="color: #333333;">)</span>
    <span style="color: #333333;">(</span><span style="color: #0000FF;">cond</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">null?</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k '<span style="color: #333333;">())]</span>
      <span style="color: #333333;">[(</span><span style="color: #006FE0;">=</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> <span style="color: #2e8b57;">8</span><span style="color: #333333;">)</span> <span style="color: #333333;">(</span>multirember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)</span> k<span style="color: #333333;">)]</span>
      <span style="color: #333333;">[</span>else <span style="color: #333333;">(</span>multirember8 <span style="color: #333333;">(</span><span style="color: #006FE0;">cdr</span> ls<span style="color: #333333;">)</span> <span style="color: #333333;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #333333;">(</span>x<span style="color: #333333;">)</span> <span style="color: #333333;">(</span>k <span style="color: #333333;">(</span><span style="color: #006FE0;">cons</span> <span style="color: #333333;">(</span><span style="color: #006FE0;">car</span> ls<span style="color: #333333;">)</span> x<span style="color: #333333;">))))])))</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Indiana course</p>
<p class="date">Created: 2015-07-19 Sun 16:55</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"></p>
</div>
</body>
</html>
